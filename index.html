<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LCC è¨‚æˆ¿æŸ¥è©¢</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-card:#1a1a25;--text-primary:#f0f0f5;--text-secondary:#8888aa;--accent-gold:#d4af37;--accent-gold-dim:#a08020;--accent-red:#e74c3c;--accent-green:#2ecc71;--accent-blue:#3498db;--accent-purple:#9b59b6;--accent-orange:#e67e22;--border-color:#2a2a3a}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans TC',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.5;-webkit-tap-highlight-color:transparent}
        .container{max-width:800px;margin:0 auto;padding:15px}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:var(--bg-card);border-radius:20px;padding:40px 30px;width:100%;max-width:350px;border:1px solid var(--border-color);text-align:center}
        .login-icon{font-size:4rem;margin-bottom:20px}
        .login-title{font-size:1.5rem;color:var(--accent-gold);margin-bottom:10px}
        .login-subtitle{color:var(--text-secondary);font-size:0.9rem;margin-bottom:30px}
        .password-input{width:100%;padding:15px;background:var(--bg-secondary);border:2px solid var(--border-color);border-radius:12px;color:var(--text-primary);font-size:1.2rem;text-align:center;letter-spacing:8px;margin-bottom:20px;font-family:inherit}
        .password-input:focus{outline:none;border-color:var(--accent-gold)}
        .password-input::placeholder{letter-spacing:normal;color:var(--text-secondary)}
        .login-btn{width:100%;padding:15px;background:var(--accent-gold);border:none;border-radius:12px;color:var(--bg-primary);font-size:1.1rem;font-weight:700;cursor:pointer;font-family:inherit}
        .login-btn:active{transform:scale(0.98)}
        .login-btn:disabled{background:var(--text-secondary)}
        .login-error{color:var(--accent-red);font-size:0.85rem;margin-top:15px;display:none}
        .login-error.show{display:block}
        .app-screen{display:none}
        .app-screen.active{display:block}
        header{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--border-color);margin-bottom:20px;flex-wrap:wrap;gap:10px}
        h1{font-size:1.3rem;color:var(--accent-gold)}
        .header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .btn{padding:10px 16px;border-radius:8px;font-family:inherit;font-size:0.85rem;cursor:pointer;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-primary)}
        .btn:active{transform:scale(0.98)}
        .btn-refresh{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue)}
        .btn-logout{background:transparent;color:var(--text-secondary);font-size:0.8rem;padding:8px 12px}
        .btn-error{background:var(--accent-orange);color:#fff;border-color:var(--accent-orange);position:relative}
        .btn-error .error-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-red);color:#fff;font-size:0.65rem;padding:2px 6px;border-radius:10px;font-weight:700}
        .data-info{font-size:0.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:6px}
        .status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent-green)}
        .status-dot.loading{background:var(--accent-blue);animation:pulse 0.5s infinite}
        .status-dot.error{background:var(--accent-red)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .tabs{display:flex;gap:10px;margin-bottom:20px}
        .tab{flex:1;padding:12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;color:var(--text-secondary);font-size:0.85rem;cursor:pointer;text-align:center}
        .tab.active{background:var(--accent-gold);color:var(--bg-primary);border-color:var(--accent-gold);font-weight:700}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .date-range-section{background:var(--bg-card);border-radius:12px;padding:20px;border:1px solid var(--accent-purple);margin-bottom:20px}
        .date-range-section h3{color:var(--accent-purple);font-size:0.95rem;margin-bottom:15px}
        .date-inputs{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .date-input-group{flex:1;min-width:140px}
        .date-input-group label{display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px}
        .date-input,.filter-select{width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:1rem}
        .date-input:focus,.filter-select:focus{outline:none;border-color:var(--accent-purple)}
        .filter-row{margin-bottom:15px}
        .btn-search{width:100%;padding:14px;background:var(--accent-purple);border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;font-family:inherit}
        .btn-search:active{transform:scale(0.98)}
        .calendar-section{background:var(--bg-card);border-radius:12px;padding:15px;border:1px solid var(--border-color);margin-bottom:20px}
        .calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .calendar-nav button{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);padding:8px 12px;border-radius:6px;cursor:pointer}
        .calendar-month{font-size:1.1rem;font-weight:500}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day-header{text-align:center;padding:8px 0;font-size:0.7rem;color:var(--text-secondary)}
        .calendar-day{aspect-ratio:1;background:var(--bg-secondary);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:2px solid transparent;min-height:44px}
        .calendar-day:active{transform:scale(0.95)}
        .calendar-day.selected{background:var(--accent-gold);color:var(--bg-primary);border-color:var(--accent-gold)}
        .calendar-day.has-guests{background:rgba(212,175,55,0.25)}
        .calendar-day .day-number{font-size:0.9rem;font-weight:500}
        .calendar-day .guest-count{font-size:0.6rem;color:var(--text-secondary)}
        .calendar-day.selected .guest-count{color:var(--bg-primary)}
        .calendar-day.other-month{opacity:0.3;pointer-events:none}
        .date-info{background:linear-gradient(135deg,var(--bg-card),var(--bg-secondary));border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid var(--accent-gold);text-align:center}
        .date-info.range{border-color:var(--accent-purple)}
        .date-info.range .date-title{color:var(--accent-purple)}
        .date-title{font-size:1.2rem;font-weight:700;color:var(--accent-gold)}
        .date-subtitle{color:var(--text-secondary);font-size:0.8rem;margin-top:3px}
        .section-label{font-size:0.75rem;color:var(--text-secondary);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .stat-card{background:var(--bg-card);border-radius:10px;padding:15px;border:1px solid var(--border-color);text-align:center}
        .stat-value{font-size:1.5rem;font-weight:700;color:var(--accent-gold)}
        .stat-label{font-size:0.7rem;color:var(--text-secondary);margin-top:3px}
        .stat-card.highlight{background:linear-gradient(135deg,var(--accent-gold-dim),#705a10);border-color:var(--accent-gold);grid-column:span 2}
        .stat-card.highlight .stat-value{color:#fff;font-size:1.8rem}
        .stat-card.highlight .stat-label{color:rgba(255,255,255,0.8)}
        .stat-card.highlight.purple{background:linear-gradient(135deg,#6a3093,#4a2070);border-color:var(--accent-purple)}
        .stat-card.cumulative{background:linear-gradient(135deg,#1a3a5c,#0d2840);border-color:var(--accent-blue)}
        .stat-card.cumulative .stat-value{color:var(--accent-blue);font-size:1.5rem}
        .calc-section{background:var(--bg-card);border-radius:12px;padding:15px;border:1px solid var(--border-color);margin-bottom:15px}
        .calc-section h3{font-size:0.9rem;color:var(--accent-gold);margin-bottom:12px}
        .calc-section.cumulative{border-color:var(--accent-blue)}
        .calc-section.cumulative h3{color:var(--accent-blue)}
        .calc-section.purple{border-color:var(--accent-purple)}
        .calc-section.purple h3{color:var(--accent-purple)}
        .calc-item{background:var(--bg-secondary);border-radius:6px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:0.85rem}
        .calc-label{color:var(--text-secondary)}
        .calc-formula{font-size:0.7rem;color:var(--text-secondary)}
        .calc-value{font-weight:700;color:var(--accent-gold)}
        .calc-total{background:var(--accent-gold-dim);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .calc-total .calc-label{color:#fff;font-weight:500}
        .calc-total .calc-value{color:#fff;font-size:1.2rem}
        .calc-section.cumulative .calc-total{background:rgba(52,152,219,0.4)}
        .calc-section.cumulative .calc-value{color:var(--accent-blue)}
        .calc-section.cumulative .calc-total .calc-value{color:#fff}
        .calc-section.purple .calc-total{background:rgba(155,89,182,0.4)}
        .calc-section.purple .calc-value{color:var(--accent-purple)}
        .calc-section.purple .calc-total .calc-value{color:#fff}
        .room-stats{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
        .room-chip{background:var(--bg-card);border:1px solid var(--border-color);border-radius:20px;padding:8px 14px;font-size:0.8rem;display:flex;align-items:center;gap:6px}
        .room-chip .type{color:var(--accent-blue);font-weight:500}
        .room-chip .count{color:var(--accent-gold);font-weight:700}
        .filters{display:flex;gap:10px;margin-bottom:15px}
        select{flex:1;padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:0.85rem}
        .table-section{background:var(--bg-card);border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
        .table-header{padding:12px 15px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}
        .table-header h2{font-size:0.95rem}
        .record-count{color:var(--text-secondary);font-size:0.8rem}
        .table-container{overflow-x:auto;max-height:400px;overflow-y:auto}
        table{width:100%;border-collapse:collapse;font-size:0.8rem}
        th,td{padding:10px 8px;text-align:left;border-bottom:1px solid var(--border-color);white-space:nowrap}
        th{background:var(--bg-secondary);font-size:0.7rem;color:var(--text-secondary);font-weight:500;position:sticky;top:0}
        .room-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:500}
        .room-RC01,.room-RC05{background:rgba(231,76,60,0.2);color:#e74c3c}
        .room-JW06{background:rgba(155,89,182,0.2);color:#9b59b6}
        .room-JW01,.room-JW01T{background:rgba(52,152,219,0.2);color:#3498db}
        .room-OK01,.room-OK01T{background:rgba(46,204,113,0.2);color:#2ecc71}
        .room-GM01,.room-GM01T{background:rgba(241,196,15,0.2);color:#f1c40f}
        .error-item{background:var(--bg-secondary);border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid var(--accent-red)}
        .error-item .error-type{font-size:0.7rem;color:var(--accent-red);text-transform:uppercase;margin-bottom:5px}
        .error-item .error-detail{font-size:0.85rem}
        .error-item .error-row{font-size:0.75rem;color:var(--text-secondary);margin-top:5px}
        .no-errors{text-align:center;padding:20px;color:var(--accent-green)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:2000;padding:20px}
        .modal-overlay.hidden{display:none}
        .modal{background:var(--bg-card);border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;border:1px solid var(--border-color)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .modal-header h2{color:var(--accent-orange);font-size:1.1rem}
        .modal-close{background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
        .loading-overlay.hidden{display:none}
        .loading-spinner{width:50px;height:50px;border:4px solid var(--border-color);border-top-color:var(--accent-gold);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{margin-top:15px;color:var(--text-secondary)}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:400px){.container{padding:10px}h1{font-size:1.1rem}.calendar-day{min-height:38px}.calendar-day .day-number{font-size:0.8rem}.stat-value{font-size:1.3rem}.stat-card.highlight .stat-value{font-size:1.5rem}}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-icon">ğŸ°</div>
            <div class="login-title">LCC è¨‚æˆ¿æŸ¥è©¢</div>
            <div class="login-subtitle">è«‹è¼¸å…¥å¯†ç¢¼é€²å…¥ç³»çµ±</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="å¯†ç¢¼" maxlength="10" inputmode="numeric">
            <button class="login-btn" id="loginBtn">é€²å…¥ç³»çµ±</button>
            <div class="login-error" id="loginError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</div>
        </div>
    </div>
    <div class="loading-overlay hidden" id="loadingOverlay"><div class="loading-spinner"></div><div class="loading-text">è¼‰å…¥è³‡æ–™ä¸­...</div></div>
    <div class="modal-overlay hidden" id="errorModal">
        <div class="modal">
            <div class="modal-header"><h2>âš ï¸ è³‡æ–™å•é¡Œ</h2><button class="modal-close" id="closeErrorModal">Ã—</button></div>
            <div id="errorList"></div>
        </div>
    </div>
    <div class="app-screen" id="appScreen">
        <div class="container">
            <header>
                <h1>ğŸ° LCC è¨‚æˆ¿æŸ¥è©¢</h1>
                <div class="header-right">
                    <div class="data-info"><span class="status-dot" id="statusDot"></span><span id="dataStatus">-</span></div>
                    <button class="btn btn-error" id="errorBtn" style="display:none;">âš ï¸<span class="error-badge" id="errorCount">0</span></button>
                    <button class="btn btn-refresh" id="refreshBtn">ğŸ”„</button>
                    <button class="btn btn-logout" id="logoutBtn">ç™»å‡º</button>
                </div>
            </header>
            <div class="tabs">
                <div class="tab active" data-tab="daily">ğŸ“… å–®æ—¥æŸ¥è©¢</div>
                <div class="tab" data-tab="range">ğŸ“† æ—¥æœŸç¯„åœ</div>
            </div>
            <div class="tab-content active" id="dailyTab">
                <div class="calendar-section">
                    <div class="calendar-nav"><button id="prevMonth">â—€</button><span class="calendar-month" id="currentMonth"></span><button id="nextMonth">â–¶</button></div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <div class="date-info" id="dateInfo" style="display:none;"><div class="date-title" id="dateTitle"></div><div class="date-subtitle">ç•¶æ™šä½å®¿</div></div>
                <div class="filters">
                    <select id="roomTypeFilter"><option value="">å…¨éƒ¨æˆ¿å‹</option></select>
                    <select id="lineHeadFilter"><option value="">å…¨éƒ¨ç·šé ­</option></select>
                </div>
                <div class="section-label">ğŸŒ™ ç•¶æ™šä½å®¿çµ±è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="dayGuests">0</div><div class="stat-label">ä½å®¿äººæ•¸</div></div>
                    <div class="stat-card"><div class="stat-value" id="dayBuyCode">0</div><div class="stat-label">è²·ç¢¼åˆè¨ˆ</div></div>
                    <div class="stat-card highlight"><div class="stat-value" id="dayWashing">0 è¬</div><div class="stat-label">ç•¶æ™šæ‰€éœ€æ´—ç¢¼é‡</div></div>
                </div>
                <div class="section-label">ğŸ¨ æˆ¿å‹åˆ†å¸ƒï¼ˆç•¶æ™šï¼‰</div>
                <div class="room-stats" id="roomStats"></div>
                <div class="calc-section"><h3>ğŸ’° ç•¶æ™šæ´—ç¢¼æ˜ç´°</h3><div id="dayCalcGrid"></div><div class="calc-total"><span class="calc-label">ç•¶æ™šç¸½è¨ˆ</span><span class="calc-value" id="dayCalcTotal">0 è¬</span></div></div>
                <div class="section-label" id="cumLabel">ğŸ“Š æœ¬æœˆç´¯è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="cumNights">0</div><div class="stat-label">ç´¯è¨ˆä½å®¿æ™šæ•¸</div></div>
                    <div class="stat-card cumulative"><div class="stat-value" id="cumWashing">0 è¬</div><div class="stat-label">ç´¯è¨ˆæ‰€éœ€æ´—ç¢¼é‡</div></div>
                </div>
                <div class="calc-section cumulative"><h3>ğŸ“ˆ æœˆç´¯è¨ˆæ´—ç¢¼æ˜ç´°</h3><div id="cumCalcGrid"></div><div class="calc-total"><span class="calc-label">ç´¯è¨ˆç¸½è¨ˆ</span><span class="calc-value" id="cumCalcTotal">0 è¬</span></div></div>
                <div class="table-section">
                    <div class="table-header"><h2>ğŸ“‹ ç•¶æ™šä½å®¿åå–®</h2><span class="record-count" id="recordCount">0 ç­†</span></div>
                    <div class="table-container"><table><thead><tr><th>å§“å</th><th>æˆ¿å‹</th><th>å…¥ä½</th><th>é€€æˆ¿</th><th>ç·šé ­</th><th>ç©å®¶</th><th>è²·ç¢¼</th></tr></thead><tbody id="tableBody"></tbody></table></div>
                </div>
            </div>
            <div class="tab-content" id="rangeTab">
                <div class="date-range-section">
                    <h3>ğŸ“† é¸æ“‡æ—¥æœŸç¯„åœ</h3>
                    <div class="date-inputs">
                        <div class="date-input-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" class="date-input" id="startDate"></div>
                        <div class="date-input-group"><label>çµæŸæ—¥æœŸ</label><input type="date" class="date-input" id="endDate"></div>
                    </div>
                    <div class="filter-row"><div class="date-input-group"><label>ç·šé ­ç¯©é¸</label><select class="filter-select" id="rangeLineFilter"><option value="">å…¨éƒ¨ç·šé ­</option></select></div></div>
                    <button class="btn-search" id="searchRange">ğŸ” æŸ¥è©¢</button>
                </div>
                <div id="rangeResults" style="display:none;">
                    <div class="date-info range"><div class="date-title" id="rangeDateTitle"></div><div class="date-subtitle" id="rangeSubtitle">æœŸé–“ä½å®¿çµ±è¨ˆ</div></div>
                    <div class="section-label">ğŸ“Š æœŸé–“çµ±è¨ˆ</div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="rangeNights">0</div><div class="stat-label">ç¸½ä½å®¿æ™šæ•¸</div></div>
                        <div class="stat-card"><div class="stat-value" id="rangeGuests">0</div><div class="stat-label">ç¸½äººæ¬¡</div></div>
                        <div class="stat-card highlight purple"><div class="stat-value" id="rangeWashing">0 è¬</div><div class="stat-label">æœŸé–“æ‰€éœ€æ´—ç¢¼é‡</div></div>
                    </div>
                    <div class="section-label">ğŸ¨ æˆ¿å‹åˆ†å¸ƒ</div>
                    <div class="room-stats" id="rangeRoomStats"></div>
                    <div class="calc-section purple"><h3>ğŸ’° æ´—ç¢¼æ˜ç´°</h3><div id="rangeCalcGrid"></div><div class="calc-total"><span class="calc-label">æœŸé–“ç¸½è¨ˆ</span><span class="calc-value" id="rangeCalcTotal">0 è¬</span></div></div>
                    <div class="table-section">
                        <div class="table-header"><h2>ğŸ“‹ æœŸé–“ä½å®¿åå–®</h2><span class="record-count" id="rangeRecordCount">0 ç­†</span></div>
                        <div class="table-container"><table><thead><tr><th>å§“å</th><th>æˆ¿å‹</th><th>å…¥ä½</th><th>é€€æˆ¿</th><th>ä½å®¿æ™šæ•¸</th><th>ç·šé ­</th><th>ç©å®¶</th><th>è²·ç¢¼</th></tr></thead><tbody id="rangeTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
const API_URL="https://script.google.com/macros/s/AKfycbxEpgtG0Mbof9F95gYUmKIp2Tdm3qQUKdhhkWtNGtMi8ANa1XpIti_SNTUa9yQyyfnW/exec";
let allBookings=[],errorRecords=[],currentMonth=new Date(),selectedDate=null,isLoggedIn=localStorage.getItem('lcc_logged_in')==='true';
const WASHING_RATES={'Mass':{'RC05':500,'RC01':200,'JW06':200,'JW01':80,'JW01T':80,'OK01':80,'OK01T':80,'GM01':80,'GM01T':80},'UT$':{'RC05':7000,'RC01':7000,'JW06':7000,'JW01':6000,'JW01T':6000,'OK01':6000,'OK01T':6000,'GM01':6000,'GM01T':6000}};
const loginScreen=document.getElementById('loginScreen'),appScreen=document.getElementById('appScreen'),loadingOverlay=document.getElementById('loadingOverlay'),passwordInput=document.getElementById('passwordInput'),loginBtn=document.getElementById('loginBtn'),loginError=document.getElementById('loginError'),errorModal=document.getElementById('errorModal');
document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));tab.classList.add('active');document.getElementById(tab.dataset.tab+'Tab').classList.add('active');}});
document.getElementById('errorBtn').onclick=()=>errorModal.classList.remove('hidden');
document.getElementById('closeErrorModal').onclick=()=>errorModal.classList.add('hidden');
function showLogin(){loginScreen.style.display='flex';appScreen.classList.remove('active');}
function showApp(){loginScreen.style.display='none';appScreen.classList.add('active');}
loginBtn.onclick=()=>tryLogin();
passwordInput.onkeydown=(e)=>{if(e.key==='Enter')tryLogin();};
async function tryLogin(){const pwd=passwordInput.value.trim();if(!pwd)return;loginBtn.disabled=true;loginBtn.textContent='é©—è­‰ä¸­...';loginError.classList.remove('show');try{const success=await loadData(pwd);if(success){localStorage.setItem('lcc_logged_in','true');localStorage.setItem('lcc_pwd',pwd);showApp();}else{loginError.classList.add('show');passwordInput.value='';passwordInput.focus();}}catch(err){loginError.textContent='é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';loginError.classList.add('show');}loginBtn.disabled=false;loginBtn.textContent='é€²å…¥ç³»çµ±';}
document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem('lcc_logged_in');localStorage.removeItem('lcc_pwd');location.reload();};
async function loadData(pwd){loadingOverlay.classList.remove('hidden');document.getElementById('statusDot').classList.add('loading');document.getElementById('dataStatus').textContent='è¼‰å…¥ä¸­...';try{const response=await fetch(API_URL+'?pwd='+encodeURIComponent(pwd));const data=await response.json();if(data.error){loadingOverlay.classList.add('hidden');document.getElementById('statusDot').classList.remove('loading');document.getElementById('statusDot').classList.add('error');return false;}allBookings=[];errorRecords=[];let rowNum=2;data.forEach(row=>{const checkIn=parseDate(row['å…¥ä½']);const checkOut=parseDate(row['é€€æˆ¿']);const roomType=row['æˆ¿å‹']||'';const name=row['å§“å']||'';const errors=[];if(!name)errors.push('ç¼ºå°‘å§“å');if(!roomType)errors.push('ç¼ºå°‘æˆ¿å‹');if(!checkIn&&row['å…¥ä½'])errors.push('å…¥ä½æ—¥æœŸæ ¼å¼éŒ¯èª¤');if(!checkIn&&!row['å…¥ä½'])errors.push('ç¼ºå°‘å…¥ä½æ—¥æœŸ');if(!checkOut&&row['é€€æˆ¿'])errors.push('é€€æˆ¿æ—¥æœŸæ ¼å¼éŒ¯èª¤');if(!checkOut&&!row['é€€æˆ¿'])errors.push('ç¼ºå°‘é€€æˆ¿æ—¥æœŸ');if(checkIn&&checkOut&&checkIn>=checkOut)errors.push('é€€æˆ¿æ—¥æœŸæ—©æ–¼å…¥ä½æ—¥æœŸ');if(errors.length>0){errorRecords.push({row:rowNum,name:name||'(ç„¡å§“å)',roomType:roomType||'(ç„¡æˆ¿å‹)',checkIn:row['å…¥ä½']||'(ç„¡)',checkOut:row['é€€æˆ¿']||'(ç„¡)',errors:errors});}if(checkIn&&roomType){allBookings.push({cardNo:row['å¡è™Ÿ']||'',name:name,roomType:roomType,checkIn:checkIn,checkOut:checkOut,days:parseInt(row['å¤©æ•¸'])||0,halfDay:row['åŠå¤©']||'',lineHead:row['ç·šé ­']||'',player:row['ç©å®¶']||'',buyCode:parseFloat(row['è²·ç¢¼'])||0,massType:row['Mass/UT$']||'Mass'});}rowNum++;});updateErrorButton();initUI();updateStatus(allBookings.length);const dates=allBookings.map(b=>b.checkIn).filter(d=>d);if(dates.length){const max=new Date(Math.max(...dates));currentMonth=new Date(max.getFullYear(),max.getMonth(),1);selectedDate=new Date();selectedDate.setHours(0,0,0,0);if(selectedDate>max)selectedDate=max;}renderCalendar();if(selectedDate)updateView(selectedDate);const today=new Date();document.getElementById('startDate').value=formatDateISO(new Date(today.getFullYear(),today.getMonth(),1));document.getElementById('endDate').value=formatDateISO(today);loadingOverlay.classList.add('hidden');return true;}catch(err){console.error(err);loadingOverlay.classList.add('hidden');document.getElementById('statusDot').classList.remove('loading');document.getElementById('statusDot').classList.add('error');document.getElementById('dataStatus').textContent='éŒ¯èª¤';return false;}}
function updateErrorButton(){const btn=document.getElementById('errorBtn');const count=document.getElementById('errorCount');if(errorRecords.length>0){btn.style.display='block';count.textContent=errorRecords.length;renderErrorList();}else{btn.style.display='none';}}
function renderErrorList(){const container=document.getElementById('errorList');if(errorRecords.length===0){container.innerHTML='<div class="no-errors">âœ… æ‰€æœ‰è³‡æ–™æ­£ç¢º</div>';return;}container.innerHTML=errorRecords.map(err=>'<div class="error-item"><div class="error-type">'+err.errors.join('ã€')+'</div><div class="error-detail"><strong>'+err.name+'</strong> - '+err.roomType+'</div><div class="error-row">ç¬¬ '+err.row+' åˆ— | å…¥ä½: '+err.checkIn+' | é€€æˆ¿: '+err.checkOut+'</div></div>').join('');}
document.getElementById('refreshBtn').onclick=async()=>{const pwd=localStorage.getItem('lcc_pwd');if(pwd)await loadData(pwd);};
function parseDate(str){if(!str)return null;if(str instanceof Date)return new Date(str.getFullYear(),str.getMonth(),str.getDate());const d=new Date(str);if(!isNaN(d.getTime()))return new Date(d.getFullYear(),d.getMonth(),d.getDate());return null;}
function formatDate(d){if(!d)return'-';return(d.getMonth()+1)+'/'+d.getDate();}
function formatDateFull(d){return d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥';}
function formatDateISO(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function getDateKey(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function parseDateKey(key){const p=key.split('-');return new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]));}
function updateStatus(n){const dot=document.getElementById('statusDot');dot.classList.remove('loading','error');document.getElementById('dataStatus').textContent=n+' ç­†';}
function initUI(){const rooms=[...new Set(allBookings.map(b=>b.roomType))].sort();const lines=[...new Set(allBookings.map(b=>b.lineHead).filter(l=>l))].sort();document.getElementById('roomTypeFilter').innerHTML='<option value="">å…¨éƒ¨æˆ¿å‹</option>'+rooms.map(r=>'<option value="'+r+'">'+r+'</option>').join('');document.getElementById('lineHeadFilter').innerHTML='<option value="">å…¨éƒ¨ç·šé ­</option>'+lines.map(l=>'<option value="'+l+'">'+l+'</option>').join('');document.getElementById('rangeLineFilter').innerHTML='<option value="">å…¨éƒ¨ç·šé ­</option>'+lines.map(l=>'<option value="'+l+'">'+l+'</option>').join('');document.getElementById('prevMonth').onclick=()=>{currentMonth.setMonth(currentMonth.getMonth()-1);renderCalendar();};document.getElementById('nextMonth').onclick=()=>{currentMonth.setMonth(currentMonth.getMonth()+1);renderCalendar();};['roomTypeFilter','lineHeadFilter'].forEach(id=>{document.getElementById(id).onchange=()=>{if(selectedDate)updateView(selectedDate);};});document.getElementById('searchRange').onclick=searchDateRange;}
function isStayingOnNight(booking,date){if(!booking.checkIn||!booking.checkOut)return false;return date.getTime()>=booking.checkIn.getTime()&&date.getTime()<booking.checkOut.getTime();}
function getStayNightsInRange(booking,startDate,endDate){if(!booking.checkIn||!booking.checkOut)return 0;let nights=0;let current=new Date(Math.max(booking.checkIn.getTime(),startDate.getTime()));const end=new Date(Math.min(booking.checkOut.getTime(),endDate.getTime()+86400000));while(current<end&&current<=endDate){nights++;current.setDate(current.getDate()+1);}return nights;}
function getMonthlyStayNights(bookings,endDate){const monthStart=new Date(endDate.getFullYear(),endDate.getMonth(),1);let totalNights=0;const roomNights={};bookings.forEach(b=>{if(!b.checkIn||!b.checkOut)return;let current=new Date(Math.max(b.checkIn.getTime(),monthStart.getTime()));const end=new Date(Math.min(b.checkOut.getTime(),endDate.getTime()+86400000));while(current<end&&current<=endDate){if(current.getMonth()===endDate.getMonth()&&current.getFullYear()===endDate.getFullYear()){totalNights++;const key=(b.massType||'Mass')+'_'+b.roomType;roomNights[key]=(roomNights[key]||0)+1;}current.setDate(current.getDate()+1);}});return{totalNights,roomNights};}
function renderCalendar(){const year=currentMonth.getFullYear();const month=currentMonth.getMonth();document.getElementById('currentMonth').textContent=year+'å¹´'+(month+1)+'æœˆ';const first=new Date(year,month,1);const last=new Date(year,month+1,0);const startDay=first.getDay();const guestCounts={};for(let day=1;day<=last.getDate();day++){const date=new Date(year,month,day);const count=allBookings.filter(b=>isStayingOnNight(b,date)).length;if(count>0)guestCounts[getDateKey(date)]=count;}let html=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=>'<div class="calendar-day-header">'+d+'</div>').join('');const prev=new Date(year,month,0);for(let i=startDay-1;i>=0;i--){html+='<div class="calendar-day other-month"><span class="day-number">'+(prev.getDate()-i)+'</span></div>';}for(let day=1;day<=last.getDate();day++){const key=year+'-'+String(month+1).padStart(2,'0')+'-'+String(day).padStart(2,'0');const count=guestCounts[key]||0;const selKey=selectedDate?getDateKey(selectedDate):'';const sel=key===selKey;html+='<div class="calendar-day '+(count>0?'has-guests ':' ')+(sel?'selected':'')+'" data-date="'+key+'"><span class="day-number">'+day+'</span>'+(count>0?'<span class="guest-count">'+count+'</span>':'')+'</div>';}const rem=42-(startDay+last.getDate());for(let d=1;d<=rem&&d<=14;d++){html+='<div class="calendar-day other-month"><span class="day-number">'+d+'</span></div>';}document.getElementById('calendarGrid').innerHTML=html;document.querySelectorAll('.calendar-day:not(.other-month)').forEach(el=>{el.onclick=()=>{selectedDate=parseDateKey(el.dataset.date);document.querySelectorAll('.calendar-day').forEach(d=>d.classList.remove('selected'));el.classList.add('selected');updateView(selectedDate);};});}
function updateView(date){const roomFilter=document.getElementById('roomTypeFilter').value;const lineFilter=document.getElementById('lineHeadFilter').value;const tonightGuests=allBookings.filter(b=>{if(!isStayingOnNight(b,date))return false;if(roomFilter&&b.roomType!==roomFilter)return false;if(lineFilter&&b.lineHead!==lineFilter)return false;return true;});const filteredBookings=allBookings.filter(b=>{if(roomFilter&&b.roomType!==roomFilter)return false;if(lineFilter&&b.lineHead!==lineFilter)return false;return true;});const cumData=getMonthlyStayNights(filteredBookings,date);document.getElementById('dateInfo').style.display='block';document.getElementById('dateTitle').textContent=formatDateFull(date);document.getElementById('cumLabel').textContent='ğŸ“Š '+(date.getMonth()+1)+'/1 ~ '+(date.getMonth()+1)+'/'+date.getDate()+' ç´¯è¨ˆ';document.getElementById('dayGuests').textContent=tonightGuests.length;document.getElementById('dayBuyCode').textContent=tonightGuests.reduce((s,b)=>s+b.buyCode,0).toLocaleString();document.getElementById('cumNights').textContent=cumData.totalNights;renderRoomStats(tonightGuests,'roomStats');const dayWash=calcWashingForGuests(tonightGuests);const cumWash=calcWashingFromRoomNights(cumData.roomNights);document.getElementById('dayWashing').textContent=dayWash.total.toLocaleString()+' è¬';document.getElementById('cumWashing').textContent=cumWash.total.toLocaleString()+' è¬';renderCalcGrid('dayCalcGrid',dayWash.details);document.getElementById('dayCalcTotal').textContent=dayWash.total.toLocaleString()+' è¬';renderCalcGrid('cumCalcGrid',cumWash.details);document.getElementById('cumCalcTotal').textContent=cumWash.total.toLocaleString()+' è¬';renderTable(tonightGuests,'tableBody','recordCount',false);}
function searchDateRange(){const startStr=document.getElementById('startDate').value;const endStr=document.getElementById('endDate').value;const lineFilter=document.getElementById('rangeLineFilter').value;if(!startStr||!endStr){alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');return;}const startDate=parseDateKey(startStr);const endDate=parseDateKey(endStr);if(startDate>endDate){alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');return;}const rangeBookings=allBookings.filter(b=>{if(!b.checkIn||!b.checkOut)return false;if(lineFilter&&b.lineHead!==lineFilter)return false;return b.checkIn<=endDate&&b.checkOut>startDate;});let totalNights=0;const roomNights={};const bookingsWithNights=rangeBookings.map(b=>{const nights=getStayNightsInRange(b,startDate,endDate);totalNights+=nights;const key=(b.massType||'Mass')+'_'+b.roomType;roomNights[key]=(roomNights[key]||0)+nights;return{...b,rangeNights:nights};}).filter(b=>b.rangeNights>0);document.getElementById('rangeResults').style.display='block';document.getElementById('rangeDateTitle').textContent=formatDateFull(startDate)+' ~ '+formatDateFull(endDate);if(lineFilter){document.getElementById('rangeSubtitle').textContent='ç·šé ­: '+lineFilter;}else{document.getElementById('rangeSubtitle').textContent='æœŸé–“ä½å®¿çµ±è¨ˆ';}document.getElementById('rangeNights').textContent=totalNights;document.getElementById('rangeGuests').textContent=bookingsWithNights.length;renderRoomStats(bookingsWithNights,'rangeRoomStats');const rangeWash=calcWashingFromRoomNights(roomNights);document.getElementById('rangeWashing').textContent=rangeWash.total.toLocaleString()+' è¬';renderCalcGrid('rangeCalcGrid',rangeWash.details);document.getElementById('rangeCalcTotal').textContent=rangeWash.total.toLocaleString()+' è¬';renderTable(bookingsWithNights,'rangeTableBody','rangeRecordCount',true);}
function renderRoomStats(guests,elementId){const counts={};guests.forEach(b=>{counts[b.roomType]=(counts[b.roomType]||0)+1;});const el=document.getElementById(elementId);if(Object.keys(counts).length===0){el.innerHTML='<span style="color:var(--text-secondary);font-size:0.85rem;">ç„¡è³‡æ–™</span>';return;}el.innerHTML=Object.keys(counts).sort().map(rt=>'<div class="room-chip"><span class="type">'+rt+'</span><span class="count">Ã—'+counts[rt]+'</span></div>').join('');}
function calcWashingForGuests(guests){const details=[];let total=0;const mass=guests.filter(b=>b.massType==='Mass');const ut=guests.filter(b=>b.massType==='UT$');const massCount={};mass.forEach(b=>{massCount[b.roomType]=(massCount[b.roomType]||0)+1;});const order=['RC05','RC01','JW06','JW01','JW01T','OK01','OK01T','GM01','GM01T'];order.forEach(rt=>{const n=massCount[rt]||0;if(n>0){const rate=WASHING_RATES['Mass'][rt]||0;const amt=n*rate;total+=amt;details.push({label:'Mass '+rt,formula:n+' é–“ Ã— '+rate+' è¬',value:amt});}});const utCount={};ut.forEach(b=>{utCount[b.roomType]=(utCount[b.roomType]||0)+1;});order.forEach(rt=>{const n=utCount[rt]||0;if(n>0){const rate=WASHING_RATES['UT$'][rt]||0;const amt=n*rate;total+=amt;details.push({label:'UT$ '+rt,formula:n+' é–“ Ã— '+rate,value:amt});}});return{details,total};}
function calcWashingFromRoomNights(roomNights){const details=[];let total=0;const order=['RC05','RC01','JW06','JW01','JW01T','OK01','OK01T','GM01','GM01T'];order.forEach(rt=>{const key='Mass_'+rt;const n=roomNights[key]||0;if(n>0){const rate=WASHING_RATES['Mass'][rt]||0;const amt=n*rate;total+=amt;details.push({label:'Mass '+rt,formula:n+' æ™š Ã— '+rate+' è¬',value:amt});}});order.forEach(rt=>{const key='UT$_'+rt;const n=roomNights[key]||0;if(n>0){const rate=WASHING_RATES['UT$'][rt]||0;const amt=n*rate;total+=amt;details.push({label:'UT$ '+rt,formula:n+' æ™š Ã— '+rate,value:amt});}});return{details,total};}
function renderCalcGrid(id,details){const el=document.getElementById(id);if(details.length===0){el.innerHTML='<div class="calc-item"><span class="calc-label">ç„¡è³‡æ–™</span></div>';return;}el.innerHTML=details.map(d=>'<div class="calc-item"><div><div class="calc-label">'+d.label+'</div><div class="calc-formula">'+d.formula+'</div></div><span class="calc-value">'+d.value.toLocaleString()+'</span></div>').join('');}
function renderTable(guests,tbodyId,countId,showRangeNights){document.getElementById(countId).textContent=guests.length+' ç­†';const tbody=document.getElementById(tbodyId);if(guests.length===0){const cols=showRangeNights?8:7;tbody.innerHTML='<tr><td colspan="'+cols+'" style="text-align:center;padding:30px;color:var(--text-secondary);">ç„¡è³‡æ–™</td></tr>';return;}if(showRangeNights){tbody.innerHTML=guests.map(b=>'<tr><td>'+b.name+'</td><td><span class="room-badge room-'+b.roomType+'">'+b.roomType+'</span></td><td>'+formatDate(b.checkIn)+'</td><td>'+formatDate(b.checkOut)+'</td><td style="color:var(--accent-purple);font-weight:700;">'+b.rangeNights+' æ™š</td><td>'+b.lineHead+'</td><td>'+b.player+'</td><td>'+b.buyCode+'</td></tr>').join('');}else{tbody.innerHTML=guests.map(b=>'<tr><td>'+b.name+'</td><td><span class="room-badge room-'+b.roomType+'">'+b.roomType+'</span></td><td>'+formatDate(b.checkIn)+'</td><td>'+formatDate(b.checkOut)+'</td><td>'+b.lineHead+'</td><td>'+b.player+'</td><td>'+b.buyCode+'</td></tr>').join('');}}
document.addEventListener('DOMContentLoaded',async()=>{if(isLoggedIn){const pwd=localStorage.getItem('lcc_pwd');if(pwd){showApp();await loadData(pwd);}else{showLogin();}}else{showLogin();}});
    </script>
</body>
</html>
