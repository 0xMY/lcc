<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LCC è¨‚æˆ¿æŸ¥è©¢</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-card:#1a1a25;--text-primary:#f0f0f5;--text-secondary:#8888aa;--accent-gold:#d4af37;--accent-gold-dim:#a08020;--accent-red:#e74c3c;--accent-green:#2ecc71;--accent-blue:#3498db;--accent-purple:#9b59b6;--accent-cyan:#00bcd4;--border-color:#2a2a3a}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans TC',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.5;-webkit-tap-highlight-color:transparent}
        .container{max-width:800px;margin:0 auto;padding:15px}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:var(--bg-card);border-radius:20px;padding:40px 30px;width:100%;max-width:350px;border:1px solid var(--border-color);text-align:center}
        .login-icon{font-size:4rem;margin-bottom:20px}
        .login-title{font-size:1.5rem;color:var(--accent-gold);margin-bottom:10px}
        .login-subtitle{color:var(--text-secondary);font-size:0.9rem;margin-bottom:30px}
        .password-input{width:100%;padding:15px;background:var(--bg-secondary);border:2px solid var(--border-color);border-radius:12px;color:var(--text-primary);font-size:1.2rem;text-align:center;letter-spacing:8px;margin-bottom:20px;font-family:inherit}
        .password-input:focus{outline:none;border-color:var(--accent-gold)}
        .password-input::placeholder{letter-spacing:normal;color:var(--text-secondary)}
        .login-btn{width:100%;padding:15px;background:var(--accent-gold);border:none;border-radius:12px;color:var(--bg-primary);font-size:1.1rem;font-weight:700;cursor:pointer;font-family:inherit}
        .login-btn:active{transform:scale(0.98)}
        .login-btn:disabled{background:var(--text-secondary)}
        .login-error{color:var(--accent-red);font-size:0.85rem;margin-top:15px;display:none}
        .login-error.show{display:block}
        .app-screen{display:none}
        .app-screen.active{display:block}
        header{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid var(--border-color);margin-bottom:20px;flex-wrap:wrap;gap:10px}
        h1{font-size:1.3rem;color:var(--accent-gold)}
        .header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .btn{padding:10px 16px;border-radius:8px;font-family:inherit;font-size:0.85rem;cursor:pointer;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-primary)}
        .btn:active{transform:scale(0.98)}
        .btn-refresh{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue)}
        .btn-logout{background:transparent;color:var(--text-secondary);font-size:0.8rem;padding:8px 12px}
        .data-info{font-size:0.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:6px}
        .status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent-green)}
        .status-dot.loading{background:var(--accent-blue);animation:pulse 0.5s infinite}
        .status-dot.error{background:var(--accent-red)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
        .tab{flex:1;min-width:80px;padding:12px 8px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;color:var(--text-secondary);font-size:0.8rem;cursor:pointer;text-align:center}
        .tab.active{background:var(--accent-gold);color:var(--bg-primary);border-color:var(--accent-gold);font-weight:700}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .query-section{background:var(--bg-card);border-radius:12px;padding:20px;border:1px solid var(--accent-purple);margin-bottom:20px}
        .query-section.cyan{border-color:var(--accent-cyan)}
        .query-section h3{color:var(--accent-purple);font-size:0.95rem;margin-bottom:15px}
        .query-section.cyan h3{color:var(--accent-cyan)}
        .input-row{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .input-group{flex:1;min-width:140px}
        .input-group label{display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px}
        .input-group input,.input-group select{width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:1rem}
        .input-group input:focus,.input-group select:focus{outline:none;border-color:var(--accent-purple)}
        .query-section.cyan .input-group input:focus,.query-section.cyan .input-group select:focus{border-color:var(--accent-cyan)}
        .btn-search{width:100%;padding:14px;background:var(--accent-purple);border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;font-family:inherit}
        .btn-search:active{transform:scale(0.98)}
        .btn-search.cyan{background:var(--accent-cyan)}
        .calendar-section{background:var(--bg-card);border-radius:12px;padding:15px;border:1px solid var(--border-color);margin-bottom:20px}
        .calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .calendar-nav button{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);padding:8px 12px;border-radius:6px;cursor:pointer}
        .calendar-month{font-size:1.1rem;font-weight:500}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day-header{text-align:center;padding:8px 0;font-size:0.7rem;color:var(--text-secondary)}
        .calendar-day{aspect-ratio:1;background:var(--bg-secondary);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:2px solid transparent;min-height:44px}
        .calendar-day:active{transform:scale(0.95)}
        .calendar-day.selected{background:var(--accent-gold);color:var(--bg-primary);border-color:var(--accent-gold)}
        .calendar-day.has-guests{background:rgba(212,175,55,0.25)}
        .calendar-day .day-number{font-size:0.9rem;font-weight:500}
        .calendar-day .guest-count{font-size:0.6rem;color:var(--text-secondary)}
        .calendar-day.selected .guest-count{color:var(--bg-primary)}
        .calendar-day.other-month{opacity:0.3;pointer-events:none}
        .date-info{background:linear-gradient(135deg,var(--bg-card),var(--bg-secondary));border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid var(--accent-gold);text-align:center}
        .date-info.range{border-color:var(--accent-purple)}
        .date-info.range .date-title{color:var(--accent-purple)}
        .date-info.kline{border-color:var(--accent-cyan)}
        .date-info.kline .date-title{color:var(--accent-cyan)}
        .date-title{font-size:1.2rem;font-weight:700;color:var(--accent-gold)}
        .date-subtitle{color:var(--text-secondary);font-size:0.8rem;margin-top:3px}
        .section-label{font-size:0.75rem;color:var(--text-secondary);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .stat-card{background:var(--bg-card);border-radius:10px;padding:15px;border:1px solid var(--border-color);text-align:center}
        .stat-value{font-size:1.5rem;font-weight:700;color:var(--accent-gold)}
        .stat-label{font-size:0.7rem;color:var(--text-secondary);margin-top:3px}
        .stat-card.highlight{background:linear-gradient(135deg,var(--accent-gold-dim),#705a10);border-color:var(--accent-gold);grid-column:span 2}
        .stat-card.highlight .stat-value{color:#fff;font-size:1.8rem}
        .stat-card.highlight .stat-label{color:rgba(255,255,255,0.8)}
        .stat-card.highlight.purple{background:linear-gradient(135deg,#6a3093,#4a2070);border-color:var(--accent-purple)}
        .stat-card.highlight.cyan{background:linear-gradient(135deg,#00838f,#006064);border-color:var(--accent-cyan)}
        .stat-card.cumulative{background:linear-gradient(135deg,#1a3a5c,#0d2840);border-color:var(--accent-blue)}
        .stat-card.cumulative .stat-value{color:var(--accent-blue);font-size:1.5rem}
        .calc-section{background:var(--bg-card);border-radius:12px;padding:15px;border:1px solid var(--border-color);margin-bottom:15px}
        .calc-section h3{font-size:0.9rem;color:var(--accent-gold);margin-bottom:12px}
        .calc-section.cumulative{border-color:var(--accent-blue)}
        .calc-section.cumulative h3{color:var(--accent-blue)}
        .calc-section.purple{border-color:var(--accent-purple)}
        .calc-section.purple h3{color:var(--accent-purple)}
        .calc-section.cyan{border-color:var(--accent-cyan)}
        .calc-section.cyan h3{color:var(--accent-cyan)}
        .calc-item{background:var(--bg-secondary);border-radius:6px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:0.85rem}
        .calc-label{color:var(--text-secondary)}
        .calc-formula{font-size:0.7rem;color:var(--text-secondary)}
        .calc-value{font-weight:700;color:var(--accent-gold)}
        .calc-total{background:var(--accent-gold-dim);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .calc-total .calc-label{color:#fff;font-weight:500}
        .calc-total .calc-value{color:#fff;font-size:1.2rem}
        .calc-section.cumulative .calc-total{background:rgba(52,152,219,0.4)}
        .calc-section.cumulative .calc-value{color:var(--accent-blue)}
        .calc-section.cumulative .calc-total .calc-value{color:#fff}
        .calc-section.purple .calc-total{background:rgba(155,89,182,0.4)}
        .calc-section.purple .calc-value{color:var(--accent-purple)}
        .calc-section.purple .calc-total .calc-value{color:#fff}
        .calc-section.cyan .calc-total{background:rgba(0,188,212,0.4)}
        .calc-section.cyan .calc-value{color:var(--accent-cyan)}
        .calc-section.cyan .calc-total .calc-value{color:#fff}
        .room-stats{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
        .room-chip{background:var(--bg-card);border:1px solid var(--border-color);border-radius:20px;padding:8px 14px;font-size:0.8rem;display:flex;align-items:center;gap:6px}
        .room-chip .type{color:var(--accent-blue);font-weight:500}
        .room-chip .count{color:var(--accent-gold);font-weight:700}
        .filters{display:flex;gap:10px;margin-bottom:15px}
        select{flex:1;padding:10px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:0.85rem}
        .table-section{background:var(--bg-card);border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
        .table-header{padding:12px 15px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center}
        .table-header h2{font-size:0.95rem}
        .record-count{color:var(--text-secondary);font-size:0.8rem}
        .table-container{overflow-x:auto;max-height:400px;overflow-y:auto}
        table{width:100%;border-collapse:collapse;font-size:0.8rem}
        th,td{padding:10px 8px;text-align:left;border-bottom:1px solid var(--border-color);white-space:nowrap}
        th{background:var(--bg-secondary);font-size:0.7rem;color:var(--text-secondary);font-weight:500;position:sticky;top:0}
        .room-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:500}
        .room-RC01,.room-RC05{background:rgba(231,76,60,0.2);color:#e74c3c}
        .room-JW06{background:rgba(155,89,182,0.2);color:#9b59b6}
        .room-JW01,.room-JW01T{background:rgba(52,152,219,0.2);color:#3498db}
        .room-OK01,.room-OK01T{background:rgba(46,204,113,0.2);color:#2ecc71}
        .room-GM01,.room-GM01T{background:rgba(241,196,15,0.2);color:#f1c40f}
        .kline-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.75rem;font-weight:500;background:rgba(0,188,212,0.2);color:var(--accent-cyan)}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}
        .loading-overlay.hidden{display:none}
        .loading-spinner{width:50px;height:50px;border:4px solid var(--border-color);border-top-color:var(--accent-gold);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{margin-top:15px;color:var(--text-secondary)}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media(max-width:400px){.container{padding:10px}h1{font-size:1.1rem}.calendar-day{min-height:38px}.calendar-day .day-number{font-size:0.8rem}.stat-value{font-size:1.3rem}.stat-card.highlight .stat-value{font-size:1.5rem}.tab{padding:10px 6px;font-size:0.75rem}}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-icon">ğŸ°</div>
            <div class="login-title">LCC è¨‚æˆ¿æŸ¥è©¢</div>
            <div class="login-subtitle">è«‹è¼¸å…¥å¯†ç¢¼é€²å…¥ç³»çµ±</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="å¯†ç¢¼" maxlength="10" inputmode="numeric">
            <button class="login-btn" id="loginBtn">é€²å…¥ç³»çµ±</button>
            <div class="login-error" id="loginError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</div>
        </div>
    </div>
    <div class="loading-overlay hidden" id="loadingOverlay"><div class="loading-spinner"></div><div class="loading-text">è¼‰å…¥è³‡æ–™ä¸­...</div></div>
    <div class="app-screen" id="appScreen">
        <div class="container">
            <header>
                <h1>ğŸ° LCC è¨‚æˆ¿æŸ¥è©¢</h1>
                <div class="header-right">
                    <div class="data-info"><span class="status-dot" id="statusDot"></span><span id="dataStatus">-</span></div>
                    <button class="btn btn-refresh" id="refreshBtn">ğŸ”„</button>
                    <button class="btn btn-logout" id="logoutBtn">ç™»å‡º</button>
                </div>
            </header>
            <div class="tabs">
                <div class="tab active" data-tab="daily">ğŸ“… å–®æ—¥</div>
                <div class="tab" data-tab="range">ğŸ“† æ—¥æœŸç¯„åœ</div>
                <div class="tab" data-tab="kline">ğŸ“Š Kç·š</div>
            </div>
            <!-- å–®æ—¥æŸ¥è©¢ -->
            <div class="tab-content active" id="dailyTab">
                <div class="calendar-section">
                    <div class="calendar-nav"><button id="prevMonth">â—€</button><span class="calendar-month" id="currentMonth"></span><button id="nextMonth">â–¶</button></div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <div class="date-info" id="dateInfo" style="display:none;"><div class="date-title" id="dateTitle"></div><div class="date-subtitle">ç•¶æ™šä½å®¿</div></div>
                <div class="filters">
                    <select id="roomTypeFilter"><option value="">å…¨éƒ¨æˆ¿å‹</option></select>
                    <select id="lineHeadFilter"><option value="">å…¨éƒ¨ç·šé ­</option></select>
                </div>
                <div class="section-label">ğŸŒ™ ç•¶æ™šä½å®¿çµ±è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="dayGuests">0</div><div class="stat-label">ä½å®¿äººæ•¸</div></div>
                    <div class="stat-card"><div class="stat-value" id="dayBuyCode">0</div><div class="stat-label">è²·ç¢¼åˆè¨ˆ</div></div>
                    <div class="stat-card highlight"><div class="stat-value" id="dayWashing">0 è¬</div><div class="stat-label">ç•¶æ™šæ‰€éœ€æ´—ç¢¼é‡</div></div>
                </div>
                <div class="section-label">ğŸ¨ æˆ¿å‹åˆ†å¸ƒï¼ˆç•¶æ™šï¼‰</div>
                <div class="room-stats" id="roomStats"></div>
                <div class="calc-section"><h3>ğŸ’° ç•¶æ™šæ´—ç¢¼æ˜ç´°</h3><div id="dayCalcGrid"></div><div class="calc-total"><span class="calc-label">ç•¶æ™šç¸½è¨ˆ</span><span class="calc-value" id="dayCalcTotal">0 è¬</span></div></div>
                <div class="section-label" id="cumLabel">ğŸ“Š æœ¬æœˆç´¯è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="cumNights">0</div><div class="stat-label">ç´¯è¨ˆä½å®¿æ™šæ•¸</div></div>
                    <div class="stat-card cumulative"><div class="stat-value" id="cumWashing">0 è¬</div><div class="stat-label">ç´¯è¨ˆæ‰€éœ€æ´—ç¢¼é‡</div></div>
                </div>
                <div class="calc-section cumulative"><h3>ğŸ“ˆ æœˆç´¯è¨ˆæ´—ç¢¼æ˜ç´°</h3><div id="cumCalcGrid"></div><div class="calc-total"><span class="calc-label">ç´¯è¨ˆç¸½è¨ˆ</span><span class="calc-value" id="cumCalcTotal">0 è¬</span></div></div>
                <div class="table-section">
                    <div class="table-header"><h2>ğŸ“‹ ç•¶æ™šä½å®¿åå–®</h2><span class="record-count" id="recordCount">0 ç­†</span></div>
                    <div class="table-container"><table><thead><tr><th>å§“å</th><th>æˆ¿å‹</th><th>å…¥ä½</th><th>é€€æˆ¿</th><th>ç·šé ­</th><th>ç©å®¶</th><th>Kç·š</th><th>è²·ç¢¼</th></tr></thead><tbody id="tableBody"></tbody></table></div>
                </div>
            </div>
            <!-- æ—¥æœŸç¯„åœæŸ¥è©¢ -->
            <div class="tab-content" id="rangeTab">
                <div class="query-section">
                    <h3>ğŸ“† é¸æ“‡æ—¥æœŸç¯„åœ</h3>
                    <div class="input-row">
                        <div class="input-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="startDate"></div>
                        <div class="input-group"><label>çµæŸæ—¥æœŸï¼ˆé€€æˆ¿æ—¥ï¼‰</label><input type="date" id="endDate"></div>
                    </div>
                    <div class="input-row"><div class="input-group"><label>ç·šé ­ç¯©é¸</label><select id="rangeLineFilter"><option value="">å…¨éƒ¨ç·šé ­</option></select></div></div>
                    <button class="btn-search" id="searchRange">ğŸ” æŸ¥è©¢</button>
                </div>
                <div id="rangeResults" style="display:none;">
                    <div class="date-info range"><div class="date-title" id="rangeDateTitle"></div><div class="date-subtitle" id="rangeSubtitle">æœŸé–“ä½å®¿çµ±è¨ˆ</div></div>
                    <div class="section-label">ğŸ“Š æœŸé–“çµ±è¨ˆ</div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="rangeNights">0</div><div class="stat-label">ç¸½ä½å®¿æ™šæ•¸</div></div>
                        <div class="stat-card"><div class="stat-value" id="rangeGuests">0</div><div class="stat-label">ç¸½äººæ¬¡</div></div>
                        <div class="stat-card highlight purple"><div class="stat-value" id="rangeWashing">0 è¬</div><div class="stat-label">æœŸé–“æ‰€éœ€æ´—ç¢¼é‡</div></div>
                    </div>
                    <div class="section-label">ğŸ¨ æˆ¿å‹åˆ†å¸ƒ</div>
                    <div class="room-stats" id="rangeRoomStats"></div>
                    <div class="calc-section purple"><h3>ğŸ’° æ´—ç¢¼æ˜ç´°</h3><div id="rangeCalcGrid"></div><div class="calc-total"><span class="calc-label">æœŸé–“ç¸½è¨ˆ</span><span class="calc-value" id="rangeCalcTotal">0 è¬</span></div></div>
                    <div class="table-section">
                        <div class="table-header"><h2>ğŸ“‹ æœŸé–“ä½å®¿åå–®</h2><span class="record-count" id="rangeRecordCount">0 ç­†</span></div>
                        <div class="table-container"><table><thead><tr><th>å§“å</th><th>æˆ¿å‹</th><th>å…¥ä½</th><th>é€€æˆ¿</th><th>æ™šæ•¸</th><th>ç·šé ­</th><th>ç©å®¶</th><th>Kç·š</th><th>è²·ç¢¼</th></tr></thead><tbody id="rangeTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
            <!-- Kç·šæŸ¥è©¢ -->
            <div class="tab-content" id="klineTab">
                <div class="query-section cyan">
                    <h3>ğŸ“Š Kç·šæŸ¥è©¢</h3>
                    <div class="input-row">
                        <div class="input-group"><label>é¸æ“‡ Kç·š</label><select id="klineSelect"><option value="">è«‹é¸æ“‡ Kç·š</option></select></div>
                    </div>
                    <div class="input-row">
                        <div class="input-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="klineStartDate"></div>
                        <div class="input-group"><label>çµæŸæ—¥æœŸï¼ˆé€€æˆ¿æ—¥ï¼‰</label><input type="date" id="klineEndDate"></div>
                    </div>
                    <button class="btn-search cyan" id="searchKline">ğŸ” æŸ¥è©¢</button>
                </div>
                <div id="klineResults" style="display:none;">
                    <div class="date-info kline"><div class="date-title" id="klineDateTitle"></div><div class="date-subtitle" id="klineSubtitle">Kç·šçµ±è¨ˆ</div></div>
                    <div class="section-label">ğŸ“Š Kç·šçµ±è¨ˆ</div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="klineNights">0</div><div class="stat-label">ç¸½ä½å®¿æ™šæ•¸</div></div>
                        <div class="stat-card"><div class="stat-value" id="klineGuests">0</div><div class="stat-label">ç¸½äººæ¬¡</div></div>
                        <div class="stat-card highlight cyan"><div class="stat-value" id="klineWashing">0 è¬</div><div class="stat-label">Kç·šæ‰€éœ€æ´—ç¢¼é‡</div></div>
                    </div>
                    <div class="section-label">ğŸ¨ æˆ¿å‹åˆ†å¸ƒ</div>
                    <div class="room-stats" id="klineRoomStats"></div>
                    <div class="calc-section cyan"><h3>ğŸ’° æ´—ç¢¼æ˜ç´°</h3><div id="klineCalcGrid"></div><div class="calc-total"><span class="calc-label">Kç·šç¸½è¨ˆ</span><span class="calc-value" id="klineCalcTotal">0 è¬</span></div></div>
                    <div class="table-section">
                        <div class="table-header"><h2>ğŸ“‹ Kç·šè¨‚æˆ¿åå–®</h2><span class="record-count" id="klineRecordCount">0 ç­†</span></div>
                        <div class="table-container"><table><thead><tr><th>å§“å</th><th>æˆ¿å‹</th><th>å…¥ä½</th><th>é€€æˆ¿</th><th>æ™šæ•¸</th><th>ç·šé ­</th><th>ç©å®¶</th><th>Kç·š</th><th>è²·ç¢¼</th></tr></thead><tbody id="klineTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
const API_URL="https://script.google.com/macros/s/AKfycbxEpgtG0Mbof9F95gYUmKIp2Tdm3qQUKdhhkWtNGtMi8ANa1XpIti_SNTUa9yQyyfnW/exec";
let allBookings=[],currentMonth=new Date(),selectedDate=null;
const WASHING_RATES={'Mass':{'RC05':500,'RC01':200,'JW06':200,'JW01':80,'JW01T':80,'OK01':80,'OK01T':80,'GM01':80,'GM01T':80},'UT$':{'RC05':7000,'RC01':7000,'JW06':7000,'JW01':6000,'JW01T':6000,'OK01':6000,'OK01T':6000,'GM01':6000,'GM01T':6000}};

document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));tab.classList.add('active');document.getElementById(tab.dataset.tab+'Tab').classList.add('active');}});

document.getElementById('loginBtn').onclick=tryLogin;
document.getElementById('passwordInput').onkeydown=e=>{if(e.key==='Enter')tryLogin();};
document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem('lcc_logged_in');localStorage.removeItem('lcc_pwd');location.reload();};
document.getElementById('refreshBtn').onclick=()=>{const pwd=localStorage.getItem('lcc_pwd');if(pwd)loadData(pwd);};

async function tryLogin(){
    const pwd=document.getElementById('passwordInput').value.trim();
    if(!pwd)return;
    document.getElementById('loginBtn').disabled=true;
    document.getElementById('loginBtn').textContent='é©—è­‰ä¸­...';
    document.getElementById('loginError').classList.remove('show');
    const success=await loadData(pwd);
    if(success){
        localStorage.setItem('lcc_logged_in','true');
        localStorage.setItem('lcc_pwd',pwd);
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('appScreen').classList.add('active');
    }else{
        document.getElementById('loginError').classList.add('show');
        document.getElementById('passwordInput').value='';
    }
    document.getElementById('loginBtn').disabled=false;
    document.getElementById('loginBtn').textContent='é€²å…¥ç³»çµ±';
}

async function loadData(pwd){
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('statusDot').classList.add('loading');
    try{
        const res=await fetch(API_URL+'?pwd='+encodeURIComponent(pwd));
        const data=await res.json();
        if(data.error){
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('statusDot').classList.remove('loading');
            document.getElementById('statusDot').classList.add('error');
            return false;
        }
        allBookings=data.map(row=>({
            name:row['å§“å']||'',
            roomType:row['æˆ¿å‹']||'',
            checkIn:parseDate(row['å…¥ä½']),
            checkOut:parseDate(row['é€€æˆ¿']),
            lineHead:row['ç·šé ­']||'',
            player:row['ç©å®¶']||'',
            kline:row['K-line']||'',
            buyCode:parseFloat(row['è²·ç¢¼'])||0,
            massType:row['Mass/UT$']||'Mass'
        })).filter(b=>b.checkIn&&b.roomType);
        
        initUI();
        document.getElementById('statusDot').classList.remove('loading','error');
        document.getElementById('dataStatus').textContent=allBookings.length+' ç­†';
        
        const dates=allBookings.map(b=>b.checkIn);
        if(dates.length){
            const max=new Date(Math.max(...dates));
            currentMonth=new Date(max.getFullYear(),max.getMonth(),1);
            selectedDate=new Date();selectedDate.setHours(0,0,0,0);
            if(selectedDate>max)selectedDate=max;
        }
        renderCalendar();
        if(selectedDate)updateView(selectedDate);
        
        const today=new Date();
        const monthStart=formatDateISO(new Date(today.getFullYear(),today.getMonth(),1));
        document.getElementById('startDate').value=monthStart;
        document.getElementById('endDate').value=formatDateISO(today);
        document.getElementById('klineStartDate').value=monthStart;
        document.getElementById('klineEndDate').value=formatDateISO(today);
        
        document.getElementById('loadingOverlay').classList.add('hidden');
        return true;
    }catch(e){
        console.error(e);
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('statusDot').classList.remove('loading');
        document.getElementById('statusDot').classList.add('error');
        return false;
    }
}

function parseDate(str){
    if(!str)return null;
    const d=new Date(str);
    return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
}
function formatDate(d){return d?(d.getMonth()+1)+'/'+d.getDate():'-';}
function formatDateFull(d){return d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥';}
function formatDateISO(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function getDateKey(d){return formatDateISO(d);}
function parseDateKey(k){const p=k.split('-');return new Date(+p[0],+p[1]-1,+p[2]);}

function initUI(){
    const rooms=[...new Set(allBookings.map(b=>b.roomType))].sort();
    const lines=[...new Set(allBookings.map(b=>b.lineHead).filter(l=>l))].sort();
    const klines=[...new Set(allBookings.map(b=>b.kline).filter(k=>k))].sort((a,b)=>{
        const na=parseInt(a.replace(/-/g,''))||0,nb=parseInt(b.replace(/-/g,''))||0;
        return na-nb;
    });
    
    document.getElementById('roomTypeFilter').innerHTML='<option value="">å…¨éƒ¨æˆ¿å‹</option>'+rooms.map(r=>'<option value="'+r+'">'+r+'</option>').join('');
    document.getElementById('lineHeadFilter').innerHTML='<option value="">å…¨éƒ¨ç·šé ­</option>'+lines.map(l=>'<option value="'+l+'">'+l+'</option>').join('');
    document.getElementById('rangeLineFilter').innerHTML='<option value="">å…¨éƒ¨ç·šé ­</option>'+lines.map(l=>'<option value="'+l+'">'+l+'</option>').join('');
    document.getElementById('klineSelect').innerHTML='<option value="">å…¨éƒ¨ Kç·š</option>'+klines.map(k=>'<option value="'+k+'">'+k+'</option>').join('');
    
    document.getElementById('prevMonth').onclick=()=>{currentMonth.setMonth(currentMonth.getMonth()-1);renderCalendar();};
    document.getElementById('nextMonth').onclick=()=>{currentMonth.setMonth(currentMonth.getMonth()+1);renderCalendar();};
    document.getElementById('roomTypeFilter').onchange=document.getElementById('lineHeadFilter').onchange=()=>{if(selectedDate)updateView(selectedDate);};
    document.getElementById('searchRange').onclick=searchDateRange;
    document.getElementById('searchKline').onclick=searchKline;
}

function isStayingOnNight(b,date){
    if(!b.checkIn||!b.checkOut)return false;
    return date>=b.checkIn&&date<b.checkOut;
}

function getStayNightsInRange(b,start,endExclusive){
    if(!b.checkIn||!b.checkOut)return 0;
    let nights=0;
    let cur=new Date(Math.max(b.checkIn.getTime(),start.getTime()));
    while(cur<b.checkOut&&cur<endExclusive){
        nights++;
        cur.setDate(cur.getDate()+1);
    }
    return nights;
}

function getMonthlyStayNights(bookings,endDate){
    const monthStart=new Date(endDate.getFullYear(),endDate.getMonth(),1);
    const endExclusive=new Date(endDate);endExclusive.setDate(endExclusive.getDate()+1);
    let totalNights=0;const roomNights={};
    bookings.forEach(b=>{
        let cur=new Date(Math.max(b.checkIn.getTime(),monthStart.getTime()));
        while(cur<b.checkOut&&cur<endExclusive){
            totalNights++;
            const key=(b.massType||'Mass')+'_'+b.roomType;
            roomNights[key]=(roomNights[key]||0)+1;
            cur.setDate(cur.getDate()+1);
        }
    });
    return{totalNights,roomNights};
}

function renderCalendar(){
    const year=currentMonth.getFullYear(),month=currentMonth.getMonth();
    document.getElementById('currentMonth').textContent=year+'å¹´'+(month+1)+'æœˆ';
    const first=new Date(year,month,1),last=new Date(year,month+1,0),startDay=first.getDay();
    const counts={};
    for(let d=1;d<=last.getDate();d++){
        const date=new Date(year,month,d);
        const n=allBookings.filter(b=>isStayingOnNight(b,date)).length;
        if(n)counts[getDateKey(date)]=n;
    }
    let html=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=>'<div class="calendar-day-header">'+d+'</div>').join('');
    const prev=new Date(year,month,0);
    for(let i=startDay-1;i>=0;i--)html+='<div class="calendar-day other-month"><span class="day-number">'+(prev.getDate()-i)+'</span></div>';
    for(let d=1;d<=last.getDate();d++){
        const key=getDateKey(new Date(year,month,d)),n=counts[key]||0,sel=selectedDate&&key===getDateKey(selectedDate);
        html+='<div class="calendar-day'+(n?' has-guests':'')+(sel?' selected':'')+'" data-date="'+key+'"><span class="day-number">'+d+'</span>'+(n?'<span class="guest-count">'+n+'</span>':'')+'</div>';
    }
    for(let d=1;d<=(42-startDay-last.getDate())&&d<=14;d++)html+='<div class="calendar-day other-month"><span class="day-number">'+d+'</span></div>';
    document.getElementById('calendarGrid').innerHTML=html;
    document.querySelectorAll('.calendar-day:not(.other-month)').forEach(el=>{
        el.onclick=()=>{
            selectedDate=parseDateKey(el.dataset.date);
            document.querySelectorAll('.calendar-day').forEach(d=>d.classList.remove('selected'));
            el.classList.add('selected');
            updateView(selectedDate);
        };
    });
}

function updateView(date){
    const rf=document.getElementById('roomTypeFilter').value,lf=document.getElementById('lineHeadFilter').value;
    const tonight=allBookings.filter(b=>isStayingOnNight(b,date)&&(!rf||b.roomType===rf)&&(!lf||b.lineHead===lf));
    const filtered=allBookings.filter(b=>(!rf||b.roomType===rf)&&(!lf||b.lineHead===lf));
    const cum=getMonthlyStayNights(filtered,date);
    
    document.getElementById('dateInfo').style.display='block';
    document.getElementById('dateTitle').textContent=formatDateFull(date);
    document.getElementById('cumLabel').textContent='ğŸ“Š '+(date.getMonth()+1)+'/1 ~ '+(date.getMonth()+1)+'/'+date.getDate()+' ç´¯è¨ˆ';
    document.getElementById('dayGuests').textContent=tonight.length;
    document.getElementById('dayBuyCode').textContent=tonight.reduce((s,b)=>s+b.buyCode,0).toLocaleString();
    document.getElementById('cumNights').textContent=cum.totalNights;
    
    renderRoomStats(tonight,'roomStats');
    const dayW=calcWashing(tonight);
    const cumW=calcWashingFromNights(cum.roomNights);
    document.getElementById('dayWashing').textContent=dayW.total.toLocaleString()+' è¬';
    document.getElementById('cumWashing').textContent=cumW.total.toLocaleString()+' è¬';
    renderCalcGrid('dayCalcGrid',dayW.details);
    document.getElementById('dayCalcTotal').textContent=dayW.total.toLocaleString()+' è¬';
    renderCalcGrid('cumCalcGrid',cumW.details);
    document.getElementById('cumCalcTotal').textContent=cumW.total.toLocaleString()+' è¬';
    renderTable(tonight,'tableBody','recordCount',false);
}

function searchDateRange(){
    const startStr=document.getElementById('startDate').value,endStr=document.getElementById('endDate').value;
    if(!startStr||!endStr){alert('è«‹é¸æ“‡æ—¥æœŸ');return;}
    const start=parseDateKey(startStr),endExclusive=parseDateKey(endStr);
    if(start>=endExclusive){alert('çµæŸæ—¥æœŸå¿…é ˆæ™šæ–¼é–‹å§‹æ—¥æœŸ');return;}
    
    const lf=document.getElementById('rangeLineFilter').value;
    const inRange=allBookings.filter(b=>b.checkIn<endExclusive&&b.checkOut>start&&(!lf||b.lineHead===lf));
    
    let totalNights=0;const roomNights={};
    const list=inRange.map(b=>{
        const n=getStayNightsInRange(b,start,endExclusive);
        totalNights+=n;
        const key=(b.massType||'Mass')+'_'+b.roomType;
        roomNights[key]=(roomNights[key]||0)+n;
        return{...b,rangeNights:n};
    }).filter(b=>b.rangeNights>0);
    
    document.getElementById('rangeResults').style.display='block';
    const lastNight=new Date(endExclusive);lastNight.setDate(lastNight.getDate()-1);
    document.getElementById('rangeDateTitle').textContent=formatDateFull(start)+' ~ '+formatDateFull(lastNight);
    document.getElementById('rangeSubtitle').textContent=lf?'ç·šé ­: '+lf:'æœŸé–“ä½å®¿çµ±è¨ˆ';
    document.getElementById('rangeNights').textContent=totalNights;
    document.getElementById('rangeGuests').textContent=list.length;
    renderRoomStats(list,'rangeRoomStats');
    const w=calcWashingFromNights(roomNights);
    document.getElementById('rangeWashing').textContent=w.total.toLocaleString()+' è¬';
    renderCalcGrid('rangeCalcGrid',w.details);
    document.getElementById('rangeCalcTotal').textContent=w.total.toLocaleString()+' è¬';
    renderTable(list,'rangeTableBody','rangeRecordCount',true);
}

function searchKline(){
    const kline=document.getElementById('klineSelect').value;
    const startStr=document.getElementById('klineStartDate').value,endStr=document.getElementById('klineEndDate').value;
    if(!startStr||!endStr){alert('è«‹é¸æ“‡æ—¥æœŸ');return;}
    const start=parseDateKey(startStr),endExclusive=parseDateKey(endStr);
    if(start>=endExclusive){alert('çµæŸæ—¥æœŸå¿…é ˆæ™šæ–¼é–‹å§‹æ—¥æœŸ');return;}
    
    const inRange=allBookings.filter(b=>b.checkIn<endExclusive&&b.checkOut>start&&(!kline||b.kline===kline));
    
    let totalNights=0;const roomNights={};
    const list=inRange.map(b=>{
        const n=getStayNightsInRange(b,start,endExclusive);
        totalNights+=n;
        const key=(b.massType||'Mass')+'_'+b.roomType;
        roomNights[key]=(roomNights[key]||0)+n;
        return{...b,rangeNights:n};
    }).filter(b=>b.rangeNights>0);
    
    document.getElementById('klineResults').style.display='block';
    const lastNight=new Date(endExclusive);lastNight.setDate(lastNight.getDate()-1);
    document.getElementById('klineDateTitle').textContent=formatDateFull(start)+' ~ '+formatDateFull(lastNight);
    document.getElementById('klineSubtitle').textContent=kline?'Kç·š: '+kline:'å…¨éƒ¨ Kç·š';
    document.getElementById('klineNights').textContent=totalNights;
    document.getElementById('klineGuests').textContent=list.length;
    renderRoomStats(list,'klineRoomStats');
    const w=calcWashingFromNights(roomNights);
    document.getElementById('klineWashing').textContent=w.total.toLocaleString()+' è¬';
    renderCalcGrid('klineCalcGrid',w.details);
    document.getElementById('klineCalcTotal').textContent=w.total.toLocaleString()+' è¬';
    renderTable(list,'klineTableBody','klineRecordCount',true);
}

function renderRoomStats(list,id){
    const c={};list.forEach(b=>c[b.roomType]=(c[b.roomType]||0)+1);
    document.getElementById(id).innerHTML=Object.keys(c).length?Object.keys(c).sort().map(r=>'<div class="room-chip"><span class="type">'+r+'</span><span class="count">Ã—'+c[r]+'</span></div>').join(''):'<span style="color:var(--text-secondary)">ç„¡è³‡æ–™</span>';
}

function calcWashing(list){
    const details=[];let total=0;
    const order=['RC05','RC01','JW06','JW01','JW01T','OK01','OK01T','GM01','GM01T'];
    ['Mass','UT$'].forEach(type=>{
        const items=list.filter(b=>b.massType===type);
        const c={};items.forEach(b=>c[b.roomType]=(c[b.roomType]||0)+1);
        order.forEach(r=>{
            const n=c[r]||0;
            if(n){const rate=WASHING_RATES[type][r]||0,amt=n*rate;total+=amt;details.push({label:type+' '+r,formula:n+' é–“ Ã— '+rate+(type==='Mass'?' è¬':''),value:amt});}
        });
    });
    return{details,total};
}

function calcWashingFromNights(roomNights){
    const details=[];let total=0;
    const order=['RC05','RC01','JW06','JW01','JW01T','OK01','OK01T','GM01','GM01T'];
    ['Mass','UT$'].forEach(type=>{
        order.forEach(r=>{
            const n=roomNights[type+'_'+r]||0;
            if(n){const rate=WASHING_RATES[type][r]||0,amt=n*rate;total+=amt;details.push({label:type+' '+r,formula:n+' æ™š Ã— '+rate+(type==='Mass'?' è¬':''),value:amt});}
        });
    });
    return{details,total};
}

function renderCalcGrid(id,details){
    document.getElementById(id).innerHTML=details.length?details.map(d=>'<div class="calc-item"><div><div class="calc-label">'+d.label+'</div><div class="calc-formula">'+d.formula+'</div></div><span class="calc-value">'+d.value.toLocaleString()+'</span></div>').join(''):'<div class="calc-item"><span class="calc-label">ç„¡è³‡æ–™</span></div>';
}

function renderTable(list,tbodyId,countId,showNights){
    document.getElementById(countId).textContent=list.length+' ç­†';
    const tbody=document.getElementById(tbodyId);
    if(!list.length){tbody.innerHTML='<tr><td colspan="'+(showNights?9:8)+'" style="text-align:center;padding:30px;color:var(--text-secondary)">ç„¡è³‡æ–™</td></tr>';return;}
    tbody.innerHTML=list.map(b=>'<tr><td>'+b.name+'</td><td><span class="room-badge room-'+b.roomType+'">'+b.roomType+'</span></td><td>'+formatDate(b.checkIn)+'</td><td>'+formatDate(b.checkOut)+'</td>'+(showNights?'<td style="color:var(--accent-purple);font-weight:700">'+b.rangeNights+' æ™š</td>':'')+'<td>'+b.lineHead+'</td><td>'+b.player+'</td><td>'+(b.kline?'<span class="kline-badge">'+b.kline+'</span>':'-')+'</td><td>'+b.buyCode+'</td></tr>').join('');
}

document.addEventListener('DOMContentLoaded',async()=>{
    if(localStorage.getItem('lcc_logged_in')==='true'){
        const pwd=localStorage.getItem('lcc_pwd');
        if(pwd){
            document.getElementById('loginScreen').style.display='none';
            document.getElementById('appScreen').classList.add('active');
            await loadData(pwd);
        }
    }
});
    </script>
</body>
</html>
